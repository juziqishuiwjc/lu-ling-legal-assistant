# GLM API 配置说明

## ✅ 已完成配置

**API Key** 已成功添加到 `app.js` 中：
```javascript
apiKey: '933b46ff0beb4fae86c84f78a3f113da.ha63T3nK4sZUOzSN'
```

## ⚠️ 重要：必须配置服务器域名

微信小程序有严格的网络请求限制，必须将 API 域名添加到白名单中。

### 方法一：配置合法域名（推荐用于正式上线）

1. **登录小程序后台**
   - 访问：https://mp.weixin.qq.com/
   - 使用注册小程序的微信账号登录

2. **添加服务器域名**
   - 进入：开发 > 开发设置 > 服务器域名
   - 找到 "request 合法域名" 部分
   - 点击"修改"按钮
   - 添加域名：`https://open.bigmodel.cn`

3. **注意事项**
   - 域名必须使用 HTTPS
   - 域名需要备案（智谱AI的域名已备案）
   - 配置后可能需要几分钟生效

### 方法二：开发阶段临时关闭校验

仅在开发调试时使用，上线时必须使用方法一。

**在微信开发者工具中：**
1. 点击右上角"详情"按钮
2. 找到"本地设置"标签
3. 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

## 🔄 API 调用流程

### 工作原理

```
用户输入问题
    ↓
小程序发送请求到智谱AI API
    ↓
API 使用您的 Key 进行验证
    ↓
GLM-4 模型生成法律建议回复
    ↓
小程序显示回复内容
```

### API 配置详情

- **API 提供商**：智谱AI (BigModel.cn)
- **使用的模型**：GLM-4
- **API 地址**：https://open.bigmodel.cn/api/paas/v4/chat/completions
- **认证方式**：Bearer Token
- **参数配置**：
  - temperature: 0.7（控制回复的创造性）
  - top_p: 0.9（控制回复的多样性）
  - max_tokens: 2000（最大回复长度）

## 💰 费用说明

### GLM-4 计费规则（参考）

- 按实际使用的 token 数量计费
- 输入和输出分别计算
- 建议定期检查智谱AI控制台的账单

**查看余额和使用情况：**
1. 访问：https://open.bigmodel.cn/
2. 登录您的账号
3. 查看控制台的"用量统计"和"账单管理"

### 成本优化建议

1. **限制上下文长度**：代码中已设置为最近10条消息
2. **设置合理的 max_tokens**：当前设置为 2000
3. **监控使用量**：定期查看 API 调用次数和费用

## 🧪 测试步骤

### 在微信开发者工具中测试

1. **打开项目**
   - 启动微信开发者工具
   - 打开小程序项目

2. **关闭域名校验**（开发阶段）
   - 详情 > 本地设置 > 不校验合法域名 ✓

3. **测试对话**
   - 在模拟器中输入法律问题
   - 例如："什么是劳动合同？"
   - 查看是否正常返回回复

4. **查看日志**
   - 打开 Console 面板
   - 检查是否有错误信息

### 真机测试

1. 点击工具栏"预览"按钮
2. 用微信扫描二维码
3. 在手机上测试对话功能

## 🐛 常见问题排查

### 问题1：提示"请先配置API Key"

**原因**：app.js 中的 apiKey 未正确配置

**解决**：
```javascript
// 检查 app.js 中的配置
glmConfig: {
  apiKey: '933b46ff0beb4fae86c84f78a3f113da.ha63T3nK4sZUOzSN'
}
```

### 问题2：网络错误或请求失败

**原因**：
- 未配置合法域名
- 域名未生效
- 网络连接问题

**解决**：
1. 开发阶段：关闭域名校验
2. 正式上线：配置合法域名 `https://open.bigmodel.cn`
3. 检查网络连接

### 问题3：API返回 401 错误

**原因**：API Key 不正确或已失效

**解决**：
1. 检查 API Key 是否正确复制
2. 登录智谱AI控制台，检查 Key 是否有效
3. 如果 Key 过期，需要重新生成

### 问题4：API返回 429 错误

**原因**：请求频率过高或余额不足

**解决**：
1. 检查账户余额
2. 降低请求频率
3. 考虑升级套餐

### 问题5：回答内容不理想

**解决**：
1. 修改 `utils/api.js` 中的系统提示词
2. 调整 temperature 参数（0-1之间，越高越创造性）
3. 调整 max_tokens 参数限制回复长度

## 🔒 安全建议

### 保护 API Key

**⚠️ 重要提醒**：
- API Key 已明文存储在前端代码中
- 小程序代码可以被反编译
- 任何人都可以获取您的 Key

### 推荐的安全做法

#### 方案1：使用后端服务器（推荐）

```
小程序 → 您的服务器 → 智谱AI API
```

**优点**：
- API Key 存储在服务器端，不暴露
- 可以做访问控制、限流等
- 便于监控和管理

**实现步骤**：
1. 搭建简单的后端服务（Node.js/Python/Java等）
2. 在服务器端调用 GLM API
3. 小程序调用您的服务器接口
4. 服务器转发请求到智谱AI

#### 方案2：使用云函数

微信小程序云函数可以隐藏 API Key：

1. 开通微信云开发
2. 创建云函数
3. 在云函数中调用 GLM API
4. 小程序调用云函数

#### 方案3：定期更换 Key

如果暂时无法使用后端：
1. 定期更换 API Key
2. 监控异常调用
3. 设置消费限额

## 📊 监控和维护

### 定期检查项

- [ ] 每周查看 API 使用量
- [ ] 检查账户余额是否充足
- [ ] 监控是否有异常调用
- [ ] 查看用户反馈
- [ ] 优化系统提示词

### 日志记录

建议添加日志功能，记录：
- API 调用次数
- 成功/失败率
- 响应时间
- 错误信息

## 📝 代码位置说明

### 配置文件
- **位置**：`app.js`
- **内容**：API Key 和 API 基础 URL

### API 调用
- **位置**：`utils/api.js`
- **函数**：
  - `callGLM4API()` - 调用智谱AI API
  - `getLegalSystemPrompt()` - 获取系统提示词

### 页面逻辑
- **位置**：`pages/index/index.js`
- **功能**：处理用户输入和显示回复

## 🚀 下一步

1. **配置服务器域名**
   - 登录小程序后台
   - 添加 `https://open.bigmodel.cn`

2. **测试功能**
   - 在开发者工具中测试对话
   - 真机预览测试

3. **监控使用**
   - 注册智谱AI账号并登录
   - 查看用量统计和账单

4. **考虑安全**
   - 评估是否需要搭建后端服务
   - 根据实际情况选择合适方案

---

**配置完成！您的小程序现在可以使用 GLM-4 进行法律咨询了。**
