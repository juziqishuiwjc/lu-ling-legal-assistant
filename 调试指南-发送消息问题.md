# "庐陵法答" 发送消息问题诊断指南

## 🔍 问题诊断步骤

### 步骤 1：检查开发者工具配置

#### 1.1 关闭域名校验（重要！）

微信小程序默认会拦截非白名单域名的网络请求，开发阶段需要关闭校验。

**操作步骤：**
1. 打开微信开发者工具
2. 点击右上角 **"详情"** 按钮
3. 切换到 **"本地设置"** 标签
4. ✅ 勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**

#### 1.2 检查调试模式

确保能看到错误信息：
1. 打开 **"调试器"** 面板（通常在底部或右侧）
2. 切换到 **"Console"** 标签
3. 查看是否有红色错误信息

---

### 步骤 2：测试发送消息

#### 2.1 在模拟器中测试

1. 在输入框输入测试问题，例如：
   ```
   你好
   ```

2. 点击"发送"按钮

3. 观察 Console 面板的输出

#### 2.2 查看可能出现的错误

**错误 A：request:fail url not in domain list**
```
错误信息：request:fail url not in domain list
```
**原因**：域名校验未关闭
**解决**：按照步骤 1.1 关闭域名校验

---

**错误 B：请先配置API Key**
```
错误信息：请先配置API Key
```
**原因**：app.js 中的 API Key 未正确配置
**解决**：
```javascript
// 检查 app.js 第 12 行
apiKey: '933b46ff0beb4fae86c84f78a3f113da.ha63T3nK4sZUOzSN'
```

---

**错误 C：request:fail (anonymous) | errno: 1**
```
错误信息：request:fail
```
**原因**：网络请求被拦截
**解决**：
- 检查是否关闭域名校验
- 检查网络连接
- 检查 API 域名是否正确

---

**错误 D：API返回 401**
```
错误信息：API响应异常 或 401 Unauthorized
```
**原因**：API Key 无效或已过期
**解决**：
1. 访问 https://open.bigmodel.cn/
2. 登录账号，检查 API Key 是否有效
3. 如果 Key 过期，重新生成并更新

---

**错误 E：API返回 429**
```
错误信息：429 Too Many Requests
```
**原因**：
- API Key 余额不足
- 请求频率过高

**解决**：
1. 检查智谱AI账户余额
2. 等待一段时间后重试

---

### 步骤 3：手动测试 API

如果想确认 API 是否可用，可以使用以下方法测试：

#### 方法 1：使用 curl 测试（需要命令行）

```bash
curl -X POST "https://open.bigmodel.cn/api/paas/v4/chat/completions" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer 933b46ff0beb4fae86c84f78a3f113da.ha63T3nK4sZUOzSN" \
  -d '{
    "model": "glm-4",
    "messages": [
      {"role": "user", "content": "你好"}
    ]
  }'
```

#### 方法 2：使用在线 API 测试工具

1. 访问：https://api.imgur.com/ 或其他 REST API 测试工具
2. 配置：
   - URL: `https://open.bigmodel.cn/api/paas/v4/chat/completions`
   - Method: `POST`
   - Headers:
     - `Content-Type: application/json`
     - `Authorization: Bearer 933b46ff0beb4fae86c84f78a3f113da.ha63T3nK4sZUOzSN`
   - Body:
     ```json
     {
       "model": "glm-4",
       "messages": [
         {"role": "user", "content": "你好"}
       ]
     }
     ```

---

### 步骤 4：检查小程序代码

#### 4.1 确认 API Key 配置

打开 `app.js` 文件，确认第 12 行：

```javascript
apiKey: '933b46ff0beb4fae86c84f78a3f113da.ha63T3nK4sZUOzSN'
```

#### 4.2 确认 API 调用代码

打开 `utils/api.js`，确认第 43-56 行的请求配置：

```javascript
wx.request({
  url: config.baseUrl,  // 应该是 'https://open.bigmodel.cn/api/paas/v4/chat/completions'
  method: 'POST',
  header: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${config.apiKey}`
  },
  data: {
    model: 'glm-4',
    messages: requestMessages,
    temperature: 0.7,
    top_p: 0.9,
    max_tokens: 2000
  },
  // ...
})
```

---

### 步骤 5：添加调试日志

如果以上都正常，仍然无法发送，可以添加更详细的日志：

#### 修改 `utils/api.js`

在第 42 行之前添加日志：

```javascript
// 调用GLM-4 API
console.log('开始调用 GLM API')
console.log('API URL:', config.baseUrl)
console.log('API Key:', config.apiKey ? '已配置' : '未配置')
console.log('请求消息:', requestMessages)

wx.request({
  // ... 现有代码
  success: (res) => {
    console.log('API 响应成功:', res)
    // ... 现有代码
  },
  fail: (err) => {
    console.error('API 调用失败:', err)
    console.error('错误详情:', JSON.stringify(err))
    // ... 现有代码
  }
})
```

---

## 🎯 快速解决方案

### 方案 1：最常见的问题 - 域名校验

**90% 的发送失败是因为这个！**

✅ **立即检查**：
1. 微信开发者工具右上角点击"详情"
2. 本地设置标签
3. 确保勾选了"不校验合法域名..."

### 方案 2：API Key 检查

在 Console 中输入以下代码检查：

```javascript
console.log(getApp().globalData.glmConfig.apiKey)
```

应该输出：
```
933b46ff0beb4fae86c84f78a3f113da.ha63T3nK4sZUOzSN
```

如果输出 `undefined` 或空字符串，说明 API Key 未正确配置。

---

## 📋 完整测试流程

### 1️⃣ 启动项目
1. 打开微信开发者工具
2. 导入项目（如果还没有）
3. 等待编译完成

### 2️⃣ 关闭域名校验
- 详情 > 本地设置 > 不校验合法域名 ✓

### 3️⃣ 打开调试器
- 底部调试器 > Console 标签

### 4️⃣ 测试发送
1. 输入框输入：`你好`
2. 点击"发送"
3. 观察 Console 输出

### 5️⃣ 查看结果
- ✅ 成功：显示 "你好！我是王吉成律师..."
- ❌ 失败：查看错误信息，对照上述排查

---

## 🐛 常见错误对照表

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `url not in domain list` | 域名校验未关闭 | 详情 > 本地设置 > 不校验合法域名 ✓ |
| `请先配置API Key` | API Key 未配置或为空 | 检查 app.js 第 12 行 |
| `401 Unauthorized` | API Key 无效 | 登录智谱AI检查 Key |
| `429 Too Many Requests` | 余额不足或频率过高 | 充值或降低请求频率 |
| `request:fail` | 网络请求被拦截 | 关闭域名校验 |
| `API响应异常` | 返回格式不符合预期 | 查看 Console 详细日志 |

---

## 💡 调试技巧

### 技巧 1：使用 Console 查看数据

在 Console 中输入：
```javascript
// 查看页面数据
getCurrentPages()[0].data

// 查看全局配置
getApp().globalData
```

### 技巧 2：手动触发 API 调用

在 Console 中输入：
```javascript
// 测试 API 调用
const { callGLM4API } = require('../../utils/api.js')
callGLM4API([{role: 'user', content: '你好'}], '你是法律助手')
  .then(res => console.log('成功:', res))
  .catch(err => console.error('失败:', err))
```

### 技巧 3：查看网络请求

1. 调试器 > Network 标签
2. 发送消息
3. 查看 `chat/completions` 请求
4. 点击查看详细信息：
   - Request URL
   - Request Headers（是否包含 Authorization）
   - Request Payload
   - Response

---

## 📞 仍然无法解决？

### 收集以下信息后寻求帮助：

1. **Console 完整错误信息**（截图或复制文本）
2. **Network 面板的请求详情**
3. **开发者工具版本**
4. **操作步骤描述**

### 提供错误信息格式：

```
【问题描述】
点击发送按钮后，消息没有发送成功

【错误信息】
Console 输出：
request:fail url not in domain list

【已尝试的解决方法】
- 已关闭域名校验 ✓
- 已检查 API Key 配置 ✓

【其他信息】
- 开发者工具版本：1.06.2309140
- 项目名称：庐陵法答
```

---

## ✅ 成功的标志

当一切正常时，您应该看到：

1. **输入框**：可以输入文字
2. **发送按钮**：输入内容后变为可点击状态（蓝色）
3. **点击发送**后：
   - 用户消息立即显示在右侧
   - 左侧显示加载动画（三个点）
   - 1-3秒后显示王律师的回复
4. **Console 输出**：
   ```
   开始调用 GLM API
   API URL: https://open.bigmodel.cn/api/paas/v4/chat/completions
   API Key: 已配置
   请求消息: [{...}]
   API 响应成功: {...}
   ```

---

**下一步**：
1. 按照上述步骤逐一检查
2. 找到错误原因
3. 应用对应的解决方案
4. 重新测试

祝调试顺利！🎉
