# 小程序安全功能说明

## 🔐 已实现的安全功能

### 1. 设备绑定（一账户一设备）

#### 功能描述
- 每个账户只能在一台设备上使用
- 如果检测到账户在其他设备登录，当前设备会自动退出

#### 实现原理

**设备ID生成**
- 应用首次启动时，自动生成唯一的设备ID（UUID格式）
- 设备ID存储在本地缓存中
- 每次启动应用时使用相同的设备ID

**绑定逻辑**
```
用户注册/登录 → 设备ID写入用户数据
    ↓
每次启动应用 → 检查当前设备ID
    ↓
与存储的设备ID比较
    ↓
匹配 → 正常使用
不匹配 → 强制退出，提示用户
```

**安全提示**
当用户在其他设备登录时，会看到：
```
安全提示

检测到您的账号在其他设备上登录，为确保账户安全，
当前设备已自动退出登录。如需继续使用，请重新设置手机号。
```

#### 代码位置
- **文件**：`app.js`
- **函数**：`initDeviceId()` - 初始化设备ID
- **检查位置**：`initUserData()` - 第 62-92 行

---

### 2. 手机号变更自动检测会员状态

#### 功能描述
- 用户修改手机号后，系统自动在后台匹配激活列表
- 如果新手机号不是会员，自动取消会员资格
- 实时更新用户状态

#### 实现原理

**检测时机**
1. 应用启动时（`checkUserActivation()`）
2. 用户修改手机号后（`setPhone()`）

**检测逻辑**
```
用户修改手机号 → 保存新手机号
    ↓
调用 checkUserActivation()
    ↓
在激活列表中查找新手机号
    ↓
找到激活记录 → 保持/激活会员
未找到激活记录 → 取消会员资格
    ↓
提示用户状态变更
```

**用户提示**

如果修改手机号导致失去会员资格：
```
会员状态变更

手机号修改成功。由于新手机号未激活会员，
您的会员资格已取消。
```

如果启动时检测到手机号变更：
```
会员状态变更

检测到您的手机号已变更，且新手机号未激活会员。
您的会员资格已取消，如需继续使用会员服务，
请联系王吉成律师激活。
```

#### 代码位置
- **检测函数**：`app.js` - `checkUserActivation()` (第 156-211 行)
- **触发位置**：
  - `app.js` - `initUserData()` (应用启动)
  - `pages/user-center/user-center.js` - `setPhone()` (修改手机号)

---

## 📊 数据结构变化

### 用户数据新增字段

```javascript
{
  phone: '12345678',        // 手机号后8位
  deviceId: 'abc-123-def',  // ✅ 新增：设备ID
  isRegistered: false,
  isPaid: false,
  planType: 'monthly',
  registerDate: '2026-01-02',
  paidDate: '2026-01-02',
  expireDate: '2026-02-02',
  dailyCount: 3,
  lastDate: '2026-01-02',
  totalQuestions: 15
}
```

### 全局数据新增字段

```javascript
globalData: {
  deviceId: '',        // ✅ 新增：当前设备ID
  userInfo: null,
  glmConfig: { ... }
}
```

---

## 🎯 使用场景

### 场景1：用户尝试在第二台设备登录

**步骤**：
1. 用户在设备A上设置手机号 `12345678`，成为会员
2. 用户尝试在设备B上打开小程序
3. 系统检测到设备ID不匹配
4. 显示安全提示，强制退出登录
5. 用户需要重新设置手机号才能使用

**结果**：✅ 防止账号共享，一个账户只能在一台设备使用

### 场景2：会员用户修改手机号

**情况A：新手机号也是会员**
1. 用户是会员（手机号：`11111111`）
2. 修改手机号为 `22222222`（`22222222` 已被激活）
3. 系统检测到 `22222222` 在激活列表中
4. 更新会员信息，保持会员身份

**情况B：新手机号不是会员**
1. 用户是会员（手机号：`11111111`）
2. 修改手机号为 `99999999`（`99999999` 未被激活）
3. 系统检测到 `99999999` 不在激活列表中
4. 自动取消会员资格
5. 显示提示：会员资格已取消

**结果**：✅ 自动检测手机号变更，防止会员账号滥用

### 场景3：老用户升级（兼容处理）

**步骤**：
1. 老用户数据中没有 `deviceId` 字段
2. 应用启动时检测到缺失
3. 自动补充当前设备ID
4. 后续正常绑定

**结果**：✅ 平滑升级，不影响老用户

---

## ⚙️ 技术细节

### 设备ID生成算法

```javascript
generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0
    const v = c === 'x' ? r : (r & 0x3 | 0x8)
    return v.toString(16)
  })
}
```

**示例**：`a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d`

### 设备ID存储位置

```javascript
// 本地存储
wx.setStorageSync('deviceId', 'abc-123-def')

// 全局变量
app.globalData.deviceId = 'abc-123-def'

// 用户数据
userInfo.deviceId = 'abc-123-def'
```

---

## 🔒 安全保障

### 多重防护

1. **设备层面**
   - ✅ 设备ID唯一性
   - ✅ 设备ID持久化存储
   - ✅ 设备不匹配自动退出

2. **会员层面**
   - ✅ 手机号与激活列表关联
   - ✅ 实时检测会员状态
   - ✅ 自动取消非法会员

3. **用户体验**
   - ✅ 清晰的安全提示
   - ✅ 防止账号滥用
   - ✅ 保护律师权益

### 防作弊机制

| 作弊方式 | 防护措施 | 状态 |
|---------|---------|------|
| 多台设备共享一个账号 | 设备ID绑定检测 | ✅ 已防护 |
| 修改手机号获取会员 | 自动检测激活状态 | ✅ 已防护 |
| 清除缓存重新注册 | 设备ID保持不变 | ✅ 已防护 |
| 转移会员资格 | 手机号变更自动取消 | ✅ 已防护 |

---

## 💡 注意事项

### 对用户的影响

**设备更换**
- 用户换手机后，需要重新设置手机号
- 如需会员服务，需联系律师重新激活

**手机号变更**
- 修改手机号前，确认新手机号已激活
- 否则会失去会员资格

### 对管理员的影响

**激活用户时**
- 确认用户手机号正确
- 激活后不可随意更改（会影响会员状态）

**用户请求改手机号**
- 需要在后台删除旧手机号的激活记录
- 使用新手机号重新激活用户

---

## 🛠️ 维护建议

### 日常维护

1. **定期检查激活列表**
   - 清理过期的激活记录
   - 验证手机号准确性

2. **处理用户请求**
   - 用户换手机：删除旧激活，用新手机号重新激活
   - 用户改手机号：同上处理

3. **监控异常**
   - 查看控制台日志
   - 关注设备ID不匹配警告
   - 关注会员资格取消记录

### 调试信息

**控制台日志**
```
当前设备ID: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
设备ID不匹配！
存储的设备ID: xxx-yyy-zzz
当前设备ID: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
用户手机号变更且未激活，取消会员资格
手机号: 12345678
```

---

## 📋 总结

### 已实现功能
- ✅ 设备ID生成和绑定
- ✅ 设备不匹配自动退出
- ✅ 手机号变更自动检测
- ✅ 会员资格自动管理
- ✅ 老用户兼容处理

### 安全级别
**适合场景**：个人小程序，防止账号共享和滥用

**优点**：
- 简单有效
- 用户友好
- 自动化管理
- 无需额外验证

**局限性**：
- 本地存储，可以被技术手段绕过
- 换手机需要重新激活
- 建议配合云开发使用更安全

---

**最后更新**：2026-01-02
**版本**：v1.1.0
