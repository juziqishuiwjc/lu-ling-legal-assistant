# 429 错误解决方案

## 🚨 错误说明

**错误代码：** 429 Too Many Requests
**含义：** API 请求频率超限或配额用完

---

## 🔍 问题原因

### 原因 1：API Key 余额不足（最常见）
- 智谱AI 账户中没有足够的余额
- 免费试用额度已用完

### 原因 2：请求频率超限
- 短时间内发送了过多请求
- 超过了 API 的 QPS（每秒请求数）限制

### 原因 3：并发请求过多
- 同时发起了多个 API 调用
- 超过了并发限制

---

## ✅ 解决步骤

### 第一步：检查账户余额

1. **登录智谱AI控制台**
   - 访问：https://open.bigmodel.cn/
   - 使用注册账号登录

2. **查看余额和配额**
   - 进入 **"账户中心"** 或 **"费用中心"**
   - 查看：
     * 账户余额
     * 剩余 Token 数量
     * 免费额度使用情况

3. **如果余额不足**
   - 充值账户
   - 或等待免费额度重置（如果有）

### 第二步：查看使用量

1. **进入用量统计**
   - 控制台 > 用量统计
   - 查看今日/本月调用量

2. **检查调用记录**
   - 查看是否有异常的大量调用
   - 确认是否有其他程序在使用相同的 API Key

### 第三步：解决方法

#### 方法 A：充值（推荐）

如果余额不足：
1. 控制台 > 充值中心
2. 选择充值金额
3. 完成支付
4. 等待充值到账（通常实时）

#### 方法 B：降低请求频率

修改 `utils/api.js` 中的参数：

```javascript
data: {
  model: 'glm-4',
  messages: requestMessages,
  temperature: 0.7,
  top_p: 0.9,
  max_tokens: 2000,
  // 添加频率限制
  stream: false  // 不使用流式传输
}
```

#### 方法 C：添加重试机制

在 `pages/index/index.js` 的 `getAssistantResponse` 方法中添加延迟：

```javascript
async getAssistantResponse(userMessage) {
  try {
    // 添加延迟，避免频繁调用
    await new Promise(resolve => setTimeout(resolve, 1000))

    const response = await callGLM4API(...)
    // ...
  } catch (error) {
    // ...
  }
}
```

#### 方法 D：使用更便宜的模型

智谱AI 提供多个模型，价格不同：

- **glm-4** - 最强，但价格较高
- **glm-4-flash** - 快速版本，价格较低
- **glm-3-turbo** - 更经济

修改 `utils/api.js` 第 62 行：

```javascript
// 从
model: 'glm-4',

// 改为（如果需要更经济的方案）
model: 'glm-4-flash',  // 或 'glm-3-turbo'
```

---

## 📊 费用参考

### GLM-4 模型定价（参考）

| 模型 | 输入价格 | 输出价格 |
|------|---------|---------|
| glm-4 | ¥0.50/千tokens | ¥2.00/千tokens |
| glm-4-flash | ¥0.10/千tokens | ¥0.40/千tokens |
| glm-3-turbo | ¥0.05/千tokens | ¥0.10/千tokens |

**说明：**
- 1 token ≈ 1.5 个中文字
- 一个简单的问答大约消耗 200-500 tokens
- 预充值金额可自定义，最低充值金额可能有所不同

---

## 🛡️ 预防措施

### 1. 添加用户限流

在发送消息时添加限制：

```javascript
// pages/index/index.js
data: {
  lastSendTime: 0,  // 上次发送时间
  minInterval: 3000  // 最小间隔3秒
},

sendMessage() {
  const now = Date.now()
  if (now - this.data.lastSendTime < this.data.minInterval) {
    wx.showToast({
      title: '请稍后再试',
      icon: 'none'
    })
    return
  }

  this.setData({ lastSendTime: now })
  // ... 继续发送
}
```

### 2. 添加每日配额提醒

```javascript
// 在 app.js 中
globalData: {
  dailyLimit: 100,  // 每日限制100次
  dailyCount: 0,    // 已使用次数
  lastDate: ''      // 上次使用的日期
}
```

### 3. 显示余额提示

在小程序中显示余额信息：

```javascript
// 在页面加载时获取余额信息
onLoad() {
  this.checkBalance()
}

checkBalance() {
  // 调用智谱AI的余额查询API
  // 如果余额不足，显示提示
}
```

---

## 🎯 快速解决

### 立即可以做的：

1. **检查余额**（最重要）
   ```
   访问：https://open.bigmodel.cn/
   登录 > 账户中心 > 查看余额
   ```

2. **如果余额为 0 或很少**
   - 充值（建议先充值少量测试，如 ¥10-50）
   - 或查看是否有免费额度

3. **充值后等待**
   - 充值通常实时到账
   - 等待 1-2 分钟后重试

4. **重新测试**
   - 在小程序中发送测试消息
   - 应该可以正常回复

---

## 💰 成本优化建议

### 1. 优化提示词长度

当前系统提示词较长（约 400 字），可以简化：

```javascript
function getLegalSystemPrompt() {
  return `你是专业的法律助手。基于中国法律提供准确、实用的法律建议。
对于重大问题提醒用户咨询专业律师。用通俗易懂的语言解释法律概念。`
}
```

### 2. 限制上下文长度

已经实现：只发送最近 10 条消息

```javascript
const recentMessages = this.data.messages.slice(-10)
```

### 3. 限制回复长度

```javascript
max_tokens: 1000  // 从 2000 降低到 1000
```

### 4. 缓存常见问题

对于常见问题（如"什么是合同"），可以：
- 预设标准答案
- 减少不必要的 API 调用

---

## 📞 联系支持

如果以上方法都无效：

1. **智谱AI官方文档**
   - https://open.bigmodel.cn/dev/api#aai_chat

2. **智谱AI社区**
   - https://open.bigmodel.cn/dev/qa

3. **提交工单**
   - 控制台 > 工单系统
   - 描述问题并附上 API Key（部分）

---

## ✅ 验证步骤

充值后的验证步骤：

1. **确认充值到账**
   - 控制台 > 账户中心
   - 确认余额已更新

2. **测试 API 调用**
   - 在小程序中发送测试消息
   - 查看 Console 中的状态码
   - 应该看到 `状态码: 200`

3. **查看回复**
   - 应该能看到王律师的回复
   - 不再显示 429 错误

---

## 🔄 后续监控

### 定期检查（建议每周）

1. 登录智谱AI控制台
2. 查看用量统计
3. 检查账户余额
4. 分析调用趋势

### 设置告警（如果支持）

- 余额不足提醒
- 用量异常告警
- API 调用失败通知

---

**总结：429 错误 90% 是因为余额不足。请先检查并充值！**
